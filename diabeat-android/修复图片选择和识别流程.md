# ä¿®å¤å›¾ç‰‡é€‰æ‹©å’Œè¯†åˆ«æµç¨‹

## âŒ é—®é¢˜æè¿°

1. é€‰æ‹©ç…§ç‰‡åæ²¡æœ‰æ˜¾ç¤ºå›¾ç‰‡
2. æ²¡æœ‰è¿›å…¥è¯†åˆ«æµç¨‹

## ğŸ” é—®é¢˜åŸå› 

1. **å›¾ç‰‡é€‰æ‹©åæœªå¤„ç†**
   - `CameraScreen` ä¸­ç›´æ¥è°ƒç”¨ `onComplete`ï¼Œæ²¡æœ‰è°ƒç”¨ `viewModel.importImage()` å¤„ç†å›¾ç‰‡

2. **ç¼ºå°‘è¯†åˆ«ç•Œé¢**
   - `MainActivity` ä¸­çš„ `onComplete` å›è°ƒæ˜¯ç©ºçš„
   - æ²¡æœ‰è¯†åˆ«ç»“æœå±•ç¤ºç•Œé¢

3. **ç¼ºå°‘è¯†åˆ«æµç¨‹**
   - æ²¡æœ‰è°ƒç”¨è¯†åˆ« API
   - æ²¡æœ‰æ˜¾ç¤ºè¯†åˆ«ç»“æœ

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤å›¾ç‰‡é€‰æ‹©å¤„ç†

**ä¿®æ”¹**ï¼šåœ¨ `CameraScreen.kt` ä¸­ï¼Œé€‰æ‹©å›¾ç‰‡åè°ƒç”¨ `viewModel.importImage()` å¤„ç†å›¾ç‰‡

```kotlin
// ä¿®å¤å‰
val imagePicker = rememberLauncherForActivityResult(
    contract = ActivityResultContracts.GetContent()
) { uri: Uri? ->
    uri?.let { onComplete(it) }
}

// ä¿®å¤å
val imagePicker = rememberLauncherForActivityResult(
    contract = ActivityResultContracts.GetContent()
) { uri: Uri? ->
    uri?.let { selectedUri ->
        // å¤„ç†é€‰æ‹©çš„å›¾ç‰‡ï¼šä¿å­˜å¹¶è§¦å‘è¯†åˆ«
        viewModel.importImage(context, selectedUri) { savedUri ->
            onComplete(savedUri)
        }
    }
}
```

### 2. åˆ›å»ºè¯†åˆ«ç•Œé¢

**æ–°å»ºæ–‡ä»¶**ï¼š`FoodRecognitionScreen.kt`

åŠŸèƒ½ï¼š
- æ˜¾ç¤ºé€‰æ‹©çš„å›¾ç‰‡
- è‡ªåŠ¨è°ƒç”¨è¯†åˆ« API
- æ˜¾ç¤ºè¯†åˆ«ç»“æœï¼ˆé£Ÿç‰©åˆ—è¡¨ã€ç½®ä¿¡åº¦ï¼‰
- æä¾›"ç»§ç»­è®¡ç®—è¥å…»"æŒ‰é’®

### 3. åˆ›å»ºè¯†åˆ« ViewModel

**æ–°å»ºæ–‡ä»¶**ï¼š`FoodRecognitionViewModel.kt`

åŠŸèƒ½ï¼š
- è°ƒç”¨è¯†åˆ« API (`/api/food/recognize`)
- ç®¡ç†è¯†åˆ«çŠ¶æ€ï¼ˆåŠ è½½ä¸­ã€ç»“æœã€é”™è¯¯ï¼‰
- å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆè½¬æ¢ä¸º MultipartBody.Partï¼‰

### 4. æ›´æ–° MainActivity

**ä¿®æ”¹**ï¼šå®ç°å¯¼èˆªé€»è¾‘

- æ·»åŠ  `MainScreen` Composable
- ç®¡ç†å±å¹•çŠ¶æ€ï¼ˆCamera / Recognitionï¼‰
- åœ¨å›¾ç‰‡é€‰æ‹©åå¯¼èˆªåˆ°è¯†åˆ«ç•Œé¢

### 5. å®Œå–„å·¥å…·ç±»

**ä¿®æ”¹**ï¼š`ImageUtil.kt`

- æ·»åŠ  `saveBitmapToFile()` æ–¹æ³•ï¼Œç”¨äºä¿å­˜å›¾ç‰‡åˆ°ä¸´æ—¶æ–‡ä»¶

### 6. ä¿®å¤ RetrofitClient

**ä¿®æ”¹**ï¼šä» `strings.xml` è¯»å– API URL

- æ·»åŠ  `init()` æ–¹æ³•
- åœ¨ `MainActivity.onCreate()` ä¸­åˆå§‹åŒ–

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶

1. âœ… `app/src/main/kotlin/com/diabeat/ui/recognition/FoodRecognitionScreen.kt`
   - è¯†åˆ«ç»“æœå±•ç¤ºç•Œé¢

2. âœ… `app/src/main/kotlin/com/diabeat/viewmodel/FoodRecognitionViewModel.kt`
   - è¯†åˆ«ä¸šåŠ¡é€»è¾‘

### ä¿®æ”¹æ–‡ä»¶

1. âœ… `app/src/main/kotlin/com/diabeat/ui/camera/CameraScreen.kt`
   - ä¿®å¤å›¾ç‰‡é€‰æ‹©åçš„å¤„ç†é€»è¾‘

2. âœ… `app/src/main/kotlin/com/diabeat/ui/MainActivity.kt`
   - æ·»åŠ å¯¼èˆªé€»è¾‘
   - åˆå§‹åŒ– RetrofitClient

3. âœ… `app/src/main/kotlin/com/diabeat/utils/ImageUtil.kt`
   - æ·»åŠ  `saveBitmapToFile()` æ–¹æ³•

4. âœ… `app/src/main/kotlin/com/diabeat/network/RetrofitClient.kt`
   - æ·»åŠ  `init()` æ–¹æ³•è¯»å–é…ç½®

5. âœ… `app/src/main/res/values/strings.xml`
   - æ·»åŠ  `api_base_url` é…ç½®

---

## âœ… åŠŸèƒ½æµç¨‹

### å®Œæ•´æµç¨‹

1. **é€‰æ‹©å›¾ç‰‡**
   - ç”¨æˆ·ç‚¹å‡»"ç›¸å†Œ"æŒ‰é’®
   - æ‰“å¼€å›¾ç‰‡é€‰æ‹©å™¨
   - é€‰æ‹©å›¾ç‰‡åï¼Œè°ƒç”¨ `viewModel.importImage()` ä¿å­˜å›¾ç‰‡

2. **å¯¼èˆªåˆ°è¯†åˆ«ç•Œé¢**
   - `MainActivity` æ¥æ”¶åˆ° `onComplete` å›è°ƒ
   - åˆ‡æ¢åˆ° `Screen.Recognition`
   - æ˜¾ç¤º `FoodRecognitionScreen`

3. **è‡ªåŠ¨è¯†åˆ«**
   - `FoodRecognitionScreen` æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
   - è‡ªåŠ¨è°ƒç”¨ `viewModel.recognizeFood()` å¼€å§‹è¯†åˆ«
   - æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨

4. **æ˜¾ç¤ºç»“æœ**
   - è¯†åˆ«å®Œæˆåï¼Œæ˜¾ç¤ºé£Ÿç‰©åˆ—è¡¨
   - æ˜¾ç¤ºæ¯ä¸ªé£Ÿç‰©çš„åç§°ã€é‡é‡ã€ç½®ä¿¡åº¦
   - æä¾›"ç»§ç»­è®¡ç®—è¥å…»"æŒ‰é’®

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### å›¾ç‰‡ä¸Šä¼ 

```kotlin
// 1. è¯»å–å›¾ç‰‡
val bitmap = ImageUtil.getBitmapFromUri(context, imageUri)

// 2. ä¿å­˜ä¸ºä¸´æ—¶æ–‡ä»¶
val tempFile = File(context.cacheDir, "temp_image_${System.currentTimeMillis()}.jpg")
ImageUtil.saveBitmapToFile(bitmap, tempFile)

// 3. åˆ›å»º MultipartBody.Part
val requestFile = tempFile.asRequestBody("image/jpeg".toMediaTypeOrNull())
val imagePart = MultipartBody.Part.createFormData("image", tempFile.name, requestFile)

// 4. è°ƒç”¨ API
val response = apiService.recognizeFood(imagePart)
```

### çŠ¶æ€ç®¡ç†

ä½¿ç”¨ `StateFlow` ç®¡ç†è¯†åˆ«çŠ¶æ€ï¼š

- `recognitionState`: è¯†åˆ«ç»“æœ
- `isLoading`: åŠ è½½çŠ¶æ€
- `error`: é”™è¯¯ä¿¡æ¯

---

## âœ… éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤

1. **é‡æ–°ç¼–è¯‘å¹¶å®‰è£…åº”ç”¨**
   ```bash
   cd diabeat-android
   ./gradlew assembleDebug
   adb install -r app/build/outputs/apk/debug/app-debug.apk
   ```

2. **æµ‹è¯•å›¾ç‰‡é€‰æ‹©**
   - æ‰“å¼€åº”ç”¨
   - ç‚¹å‡»"ç›¸å†Œ"æŒ‰é’®
   - é€‰æ‹©ä¸€å¼ é£Ÿç‰©å›¾ç‰‡
   - åº”è¯¥è‡ªåŠ¨è·³è½¬åˆ°è¯†åˆ«ç•Œé¢

3. **æµ‹è¯•è¯†åˆ«æµç¨‹**
   - è¯†åˆ«ç•Œé¢åº”è¯¥æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
   - æ˜¾ç¤º"æ­£åœ¨è¯†åˆ«é£Ÿç‰©..."åŠ è½½æç¤º
   - è¯†åˆ«å®Œæˆåæ˜¾ç¤ºé£Ÿç‰©åˆ—è¡¨
   - ç‚¹å‡»"ç»§ç»­è®¡ç®—è¥å…»"æŒ‰é’®ï¼ˆåç»­å¯ä»¥è·³è½¬åˆ°è¥å…»è®¡ç®—é¡µé¢ï¼‰

---

## ğŸ” å¦‚æœä»ç„¶æœ‰é—®é¢˜

### æ£€æŸ¥ç½‘ç»œè¿æ¥

ç¡®ä¿ï¼š
- æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼ˆ`http://10.0.2.2:8000`ï¼‰
- æ¨¡æ‹Ÿå™¨å¯ä»¥è®¿é—®æœåŠ¡å™¨
- API ç«¯ç‚¹æ­£ç¡®ï¼ˆ`/api/food/recognize`ï¼‰

### æ£€æŸ¥æƒé™

ç¡®ä¿ AndroidManifest.xml ä¸­æœ‰ï¼š
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
```

### æ£€æŸ¥æ—¥å¿—

æŸ¥çœ‹ Logcat ä¸­çš„é”™è¯¯ä¿¡æ¯ï¼š
```bash
adb logcat | grep -i "diabeat\|error\|exception"
```

---

**ä¿®å¤å®Œæˆ**ï¼šå›¾ç‰‡é€‰æ‹©å’Œè¯†åˆ«æµç¨‹åº”è¯¥æ­£å¸¸å·¥ä½œäº†ï¼âœ…

ç°åœ¨é€‰æ‹©å›¾ç‰‡åä¼šï¼š
1. âœ… æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
2. âœ… è‡ªåŠ¨å¼€å§‹è¯†åˆ«
3. âœ… æ˜¾ç¤ºè¯†åˆ«ç»“æœ
4. âœ… å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥æ“ä½œ

