# 真机配置说明

## 📱 真机运行配置

### 当前配置

已更新 API 地址为真机可访问的地址：
- **API URL**: `http://192.168.1.249:8000`

---

## ✅ 配置步骤

### 1. 确保服务器正在运行

在电脑上启动服务器：

```bash
cd diabeat-server
python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**重要**：必须使用 `--host 0.0.0.0`，这样服务器才能接受来自局域网的连接。

### 2. 检查网络连接

确保：
- ✅ 手机和电脑连接到**同一个 WiFi 网络**
- ✅ 电脑防火墙允许 8000 端口
- ✅ 服务器绑定到 `0.0.0.0:8000`（不是 `127.0.0.1`）

### 3. 测试连接

在手机上打开浏览器，访问：
```
http://192.168.1.249:8000/docs
```

如果能看到 API 文档页面，说明连接正常。

---

## 🔧 切换配置（模拟器 vs 真机）

### 方法 1：修改 strings.xml

**真机配置**：
```xml
<string name="api_base_url">http://192.168.1.249:8000</string>
```

**模拟器配置**：
```xml
<string name="api_base_url">http://10.0.2.2:8000</string>
```

### 方法 2：使用 Build Variants（推荐）

可以创建不同的构建变体，自动切换配置。

---

## 🔍 常见问题排查

### 问题 1：无法连接到服务器

**检查清单**：
1. ✅ 服务器是否正在运行？
   ```bash
   # 检查服务器是否在运行
   curl http://192.168.1.249:8000/health
   ```

2. ✅ 手机和电脑是否在同一 WiFi？
   - 在手机上打开 WiFi 设置，确认网络名称

3. ✅ 防火墙是否阻止连接？
   - macOS: 系统偏好设置 → 安全性与隐私 → 防火墙
   - Windows: 控制面板 → Windows Defender 防火墙

4. ✅ IP 地址是否正确？
   ```bash
   # 在电脑上查看 IP 地址
   # macOS/Linux:
   ifconfig | grep "inet "
   
   # Windows:
   ipconfig
   ```

### 问题 2：连接超时

**可能原因**：
- 服务器未绑定到 `0.0.2.0`
- 防火墙阻止连接
- IP 地址已更改

**解决方案**：
1. 重启服务器，确保使用 `--host 0.0.0.0`
2. 检查防火墙设置
3. 重新获取电脑的 IP 地址并更新配置

### 问题 3：SSL/HTTPS 错误

如果使用 HTTPS，需要：
1. 配置 SSL 证书
2. 更新 API URL 为 `https://192.168.1.249:8000`
3. 在 Android 中配置网络安全策略

---

## 📝 快速切换脚本

可以创建一个脚本快速切换配置：

```bash
#!/bin/bash
# switch_api.sh

if [ "$1" == "device" ]; then
    sed -i '' 's|http://10.0.2.2:8000|http://192.168.1.249:8000|g' app/src/main/res/values/strings.xml
    echo "✅ 已切换到真机配置"
elif [ "$1" == "emulator" ]; then
    sed -i '' 's|http://192.168.1.249:8000|http://10.0.2.2:8000|g' app/src/main/res/values/strings.xml
    echo "✅ 已切换到模拟器配置"
else
    echo "用法: ./switch_api.sh [device|emulator]"
fi
```

---

## 🎯 验证步骤

1. **更新配置**
   - ✅ 已更新 `strings.xml` 中的 API URL

2. **重新编译应用**
   ```bash
   cd diabeat-android
   ./gradlew clean
   ./gradlew assembleDebug
   ```

3. **安装到真机**
   ```bash
   adb install -r app/build/outputs/apk/debug/app-debug.apk
   ```

4. **测试连接**
   - 打开应用
   - 选择图片进行识别
   - 查看是否能正常调用 API

---

## 📋 当前配置

- **API URL**: `http://192.168.1.249:8000`
- **服务器地址**: `0.0.0.0:8000`（接受所有网络接口的连接）
- **网络要求**: 手机和电脑在同一 WiFi 网络

---

**配置完成**：现在应该可以在真机上正常连接服务器了！✅

如果仍有问题，请检查：
1. 服务器是否正在运行
2. 网络连接是否正常
3. 防火墙设置是否正确

