# AWS S3 配置 - 下一步操作指南

## ✅ 您已完成

根据您的信息：
- ✅ S3 存储桶：`diabeat-ai-images`
- ✅ AWS 区域：`us-east-2`（美国东部俄亥俄）
- ✅ IAM 用户：`diabeat-s3-user`
- ✅ IAM 策略：`DiabEatS3Policy`

## 🔑 接下来：获取访问密钥

### 操作步骤

#### 1. 进入 IAM 用户页面

1. 在 AWS Console 顶部搜索栏输入 **"IAM"**
2. 点击 **IAM** 服务
3. 左侧菜单点击 **"用户"**
4. 找到并点击用户：**`diabeat-s3-user`**

#### 2. 创建访问密钥

1. 在用户详情页面，点击 **"安全凭证"** 标签（Security credentials）
2. 滚动到 **"访问密钥"** 部分（Access keys）
3. 点击 **"创建访问密钥"** 按钮（Create access key）

#### 3. 选择使用案例

1. 选择 **"应用程序在 AWS 外部运行"**（Application running outside AWS）
2. 点击 **"下一步"**（Next）

#### 4. 获取并保存访问密钥 ⚠️ 重要

1. **页面会显示访问密钥信息**：
   - **访问密钥 ID**（Access key ID）：例如 `AKIAIOSFODNN7EXAMPLE`
   - **秘密访问密钥**（Secret access key）：例如 `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`

2. ⚠️ **立即保存**（非常重要）：
   - 点击 **"下载 .csv 文件"** 按钮（推荐）
   - 或立即复制并保存到安全位置
   - **秘密访问密钥只显示一次，如果丢失需要重新创建**

3. 点击 **"完成"**（Done）

---

## 📝 配置到项目

### 步骤 1：生成 S3 URL

根据您的信息：
- 存储桶名称：`diabeat-ai-images`
- 区域：`us-east-2`

**S3 URL**：
```
https://diabeat-ai-images.s3.us-east-2.amazonaws.com
```

### 步骤 2：编辑配置文件

编辑 `diabeat-server/config/.env` 文件：

```env
# AWS S3 配置
AWS_ACCESS_KEY_ID=您的访问密钥ID
AWS_SECRET_ACCESS_KEY=您的秘密访问密钥
AWS_REGION=us-east-2
AWS_S3_BUCKET=diabeat-ai-images
S3_URL=https://diabeat-ai-images.s3.us-east-2.amazonaws.com
```

⚠️ **替换为您的实际值**：
- `AWS_ACCESS_KEY_ID`：替换为您在第4步获取的访问密钥 ID
- `AWS_SECRET_ACCESS_KEY`：替换为您在第4步获取的秘密访问密钥

### 步骤 3：安装依赖

```bash
cd diabeat-server
pip install boto3
```

### 步骤 4：测试配置

```bash
# 运行测试脚本
python test_s3_config.py
```

如果测试通过，您会看到：
```
✅ 连接成功！
✅ 目标存储桶 'diabeat-ai-images' 存在
✅ 测试文件上传成功
✅ 测试文件下载成功
✅ 测试文件已删除
🎉 S3 配置测试通过！
```

---

## 📋 完整配置示例

您的 `config/.env` 文件应该包含：

```env
# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/diabeat

# JWT 配置
SECRET_KEY=your-secret-key-change-in-production

# AI 配置
OPENAI_API_KEY=your-openai-key
DASHSCOPE_API_KEY=your-dashscope-key

# AWS S3 配置
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_REGION=us-east-2
AWS_S3_BUCKET=diabeat-ai-images
S3_URL=https://diabeat-ai-images.s3.us-east-2.amazonaws.com
```

---

## 🔍 验证配置

### 方法 1：使用测试脚本

```bash
python test_s3_config.py
```

### 方法 2：在代码中验证

```python
from app.config import settings
from app.storage.s3 import S3StorageProvider

# 创建 S3 存储提供者
storage = S3StorageProvider(
    bucket_name=settings.AWS_S3_BUCKET,
    aws_access_key_id=settings.AWS_ACCESS_KEY_ID,
    aws_secret_access_key=settings.AWS_SECRET_ACCESS_KEY,
    region=settings.AWS_REGION
)

# 测试上传
test_data = b"Hello S3!"
url = await storage.save(test_data, "test/test.txt")
print(f"上传成功: {url}")
```

---

## 🆘 常见问题

### Q1: 找不到"创建访问密钥"按钮

**A**: 
- 确保您在用户详情页面的 **"安全凭证"** 标签
- 如果刚创建用户，可能需要刷新页面
- 检查用户是否有创建访问密钥的权限

### Q2: 测试时提示"权限不足"

**A**: 
- 检查策略是否正确附加到用户
- 检查策略中的存储桶名称是否为 `diabeat-ai-images`
- 检查策略中的操作权限是否包含：`PutObject`, `GetObject`, `DeleteObject`, `ListBucket`

### Q3: 存储桶不存在错误

**A**: 
- 确认存储桶名称：`diabeat-ai-images`
- 确认区域：`us-east-2`
- 在 S3 控制台检查存储桶是否存在

---

## ✅ 完成检查清单

- [ ] 已获取访问密钥 ID
- [ ] 已获取秘密访问密钥（已保存到安全位置）
- [ ] 已在 `config/.env` 文件中配置所有信息
- [ ] 已安装 `boto3` 依赖
- [ ] 已运行测试脚本并测试通过

---

**配置完成后，系统会自动使用 S3 存储图片，而不是本地存储。**

