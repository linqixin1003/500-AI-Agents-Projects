# ğŸ“± ç”¨æˆ·è®¤è¯å’Œæ•°æ®ç®¡ç†åˆ†ææŠ¥å‘Š

## âœ… å½“å‰å®ç°çŠ¶æ€

### 1. Device ID â†’ User ID æµç¨‹ âœ… å·²å®ç°

#### æµç¨‹è¯´æ˜ï¼š
```
APPå¯åŠ¨ 
  â†’ ç”Ÿæˆ/è·å–Device ID (DeviceIdUtil)
  â†’ è°ƒç”¨ /api/users/device-auth
  â†’ æœåŠ¡å™¨æ£€æŸ¥device_idæ˜¯å¦å­˜åœ¨
     â”œâ”€ å­˜åœ¨ï¼šè¿”å›ç°æœ‰ç”¨æˆ·çš„JWT token
     â””â”€ ä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°ç”¨æˆ·å¹¶è¿”å›JWT token
  â†’ APPä¿å­˜ access_token å’Œ user_id
  â†’ æ‰€æœ‰åç»­è¯·æ±‚å¸¦ Authorization: Bearer <token>
  â†’ æœåŠ¡å™¨ä»tokenè§£æå‡ºuser_id
  â†’ æ‰€æœ‰æ•°æ®æŸ¥è¯¢åŸºäºuser_id
```

### 2. æ ¸å¿ƒå®ç°æ–‡ä»¶

#### åç«¯ï¼ˆdiabeat-serverï¼‰

1. **ç”¨æˆ·è®¤è¯è·¯ç”±** (`app/user/router.py`)
   ```python
   @router.post("/device-auth")
   async def device_auth(request: DeviceAuthRequest):
       # 1. æ ¹æ®device_idæŸ¥æ‰¾ç”¨æˆ·
       user = await crud.get_user_by_device_id(request.device_id)
       
       # 2. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
       if not user:
           user_id = await crud.create_user_with_device_id(
               device_id=request.device_id,
               diabetes_type=request.diabetes_type,
               name=request.name
           )
           user = await crud.get_user_by_id(user_id)
       
       # 3. ç”ŸæˆJWT token (åŒ…å«user_id)
       access_token = auth_service.create_access_token(
           data={"sub": str(user["id"])}
       )
       
       return TokenResponse(access_token=access_token, user=user_response)
   ```

2. **ç”¨æˆ·CRUD** (`app/user/crud.py`)
   - âœ… `get_user_by_device_id()` - æ ¹æ®device_idæŸ¥æ‰¾ç”¨æˆ·
   - âœ… `create_user_with_device_id()` - åˆ›å»ºç”¨æˆ·æ—¶ç”ŸæˆUUID
   - âœ… `get_user_by_id()` - æ ¹æ®user_idè·å–ç”¨æˆ·ä¿¡æ¯

3. **è®¤è¯æœåŠ¡** (`app/user/auth_service.py`)
   - âœ… `create_access_token()` - åˆ›å»ºJWT tokenï¼ˆåŒ…å«user_idï¼‰
   - âœ… `get_current_user()` - ä»tokenè§£æuser_idå¹¶è·å–ç”¨æˆ·ä¿¡æ¯

#### å‰ç«¯ï¼ˆdiabeat-androidï¼‰

1. **Tokenç®¡ç†å™¨** (`TokenManager.kt`)
   ```kotlin
   suspend fun ensureAuthenticated(context: Context, apiService: ApiService) {
       // 1. æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆtoken
       val token = getToken(context)
       if (token.isNotNullOrBlank()) {
           return LoginResponse(token, user)
       }
       
       // 2. ä½¿ç”¨device_idè¿›è¡Œè®¤è¯
       val deviceId = DeviceIdUtil.getDeviceId()
       val authRequest = DeviceAuthRequest(
           device_id = deviceId,
           diabetes_type = "type2"
       )
       
       // 3. è°ƒç”¨è®¤è¯API
       val response = apiService.deviceAuth(authRequest)
       
       // 4. ä¿å­˜tokenå’Œuser_id
       saveToken(context, response.access_token)
       saveUserId(context, response.user.id)
   }
   ```

2. **è®¾å¤‡IDå·¥å…·** (`DeviceIdUtil.kt`)
   - âœ… ç”Ÿæˆå”¯ä¸€è®¾å¤‡ID
   - âœ… æŒä¹…åŒ–å­˜å‚¨åˆ°SharedPreferences

### 3. æ‰€æœ‰APIéƒ½åŸºäºUser ID âœ…

æ£€æŸ¥ç»“æœæ˜¾ç¤ºï¼Œæ‰€æœ‰å—ä¿æŠ¤çš„APIç«¯ç‚¹éƒ½ä½¿ç”¨äº† `current_user: UserResponse = Depends(get_current_user_dependency)`

**å·²éªŒè¯çš„APIï¼š**
- âœ… é£Ÿç‰©è¯†åˆ« `/api/food/recognize` - ä½¿ç”¨ `current_user.id`
- âœ… è¥å…»è®¡ç®— `/api/nutrition/*` - ä½¿ç”¨ `current_user.id`
- âœ… ç”¨é¤è®°å½• `/api/records/meals` - ä½¿ç”¨ `current_user.id`
- âœ… è¿åŠ¨è®°å½• `/api/records/exercise` - ä½¿ç”¨ `current_user.id`
- âœ… æ°´åˆ†è®°å½• `/api/records/water` - ä½¿ç”¨ `current_user.id`
- âœ… ç”¨è¯è®°å½• `/api/records/medication` - ä½¿ç”¨ `current_user.id`
- âœ… èƒ°å²›ç´ è®°å½• `/api/records/insulin` - ä½¿ç”¨ `current_user.id`
- âœ… è¡€ç³–é¢„æµ‹ `/api/prediction/*` - ä½¿ç”¨ `current_user.id`
- âœ… é€šçŸ¥ç®¡ç† `/api/notifications/*` - ä½¿ç”¨ `current_user.id`

## ğŸ“Š æ•°æ®æµç¤ºæ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APPå¯åŠ¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeviceIdUtil.init() â”‚  ç”Ÿæˆ/è·å–Device ID
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TokenManager             â”‚
â”‚  .ensureAuthenticated()  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ æœ‰token? â”€â”€YESâ”€â”€> ä½¿ç”¨ç°æœ‰token
       â”‚
       â””â”€ NO â”€> device_auth API
                    â”‚
                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  åç«¯æ£€æŸ¥DB       â”‚
              â”‚  device_idå­˜åœ¨?  â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
       YES                   NO
        â”‚                     â”‚
        â–¼                     â–¼
   è¿”å›ç°æœ‰ç”¨æˆ·          åˆ›å»ºæ–°ç”¨æˆ·
   (user_id)           (ç”ŸæˆUUID)
        â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
           ç”ŸæˆJWT Token
          (åŒ…å«user_id)
                   â”‚
                   â–¼
           è¿”å›ç»™APP
                   â”‚
                   â–¼
         ä¿å­˜tokenå’Œuser_id
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  åç»­æ‰€æœ‰APIè¯·æ±‚        â”‚
    â”‚  Header:                â”‚
    â”‚  Authorization: Bearer  â”‚
    â”‚  <token>               â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    åç«¯ä»tokenè§£æuser_id
           â”‚
           â–¼
    ä½¿ç”¨user_idæŸ¥è¯¢ç”¨æˆ·æ•°æ®
```

## ğŸ” è¯¦ç»†æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹

### 1. ç”¨é¤è®°å½•æŸ¥è¯¢
```python
# app/records/crud.py
async def get_recent_meal_records(user_id: str, limit: int = 10):
    query = """
        SELECT * FROM meal_records 
        WHERE user_id = :user_id 
        ORDER BY meal_time DESC 
        LIMIT :limit
    """
    return await database.fetch_all(
        query=query, 
        values={"user_id": user_id, "limit": limit}
    )
```

### 2. è¥å…»æ‘„å…¥ç»Ÿè®¡
```python
# app/nutrition/service.py
async def get_today_intake(user_id: str):
    query = """
        SELECT 
            SUM(nr.total_calories) as total_calories,
            SUM(nr.total_carbs) as total_carbs,
            SUM(nr.total_protein) as total_protein,
            SUM(nr.total_fat) as total_fat
        FROM nutrition_records nr
        JOIN meal_records mr ON nr.id = mr.nutrition_record_id
        WHERE mr.user_id = :user_id
        AND DATE(mr.meal_time) = CURRENT_DATE
    """
    return await database.fetch_one(
        query=query,
        values={"user_id": user_id}
    )
```

### 3. è¿åŠ¨è®°å½•æŸ¥è¯¢
```python
# app/records/crud.py
async def get_today_exercise_summary(user_id: str):
    query = """
        SELECT 
            SUM(calories_burned) as total_calories,
            SUM(duration_minutes) as total_duration,
            COUNT(*) as exercise_count
        FROM exercise_records
        WHERE user_id = :user_id
        AND DATE(exercise_time) = CURRENT_DATE
    """
    return await database.fetch_one(
        query=query,
        values={"user_id": user_id}
    )
```

## âœ… éªŒè¯æ¸…å•

- [x] Device ID ç”Ÿæˆå’ŒæŒä¹…åŒ–
- [x] Device ID â†’ User ID æ˜ å°„
- [x] JWT Token åŒ…å« user_id
- [x] æ‰€æœ‰APIä½¿ç”¨ current_user ä¾èµ–æ³¨å…¥
- [x] æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢åŸºäº user_id
- [x] Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- [x] ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

## ğŸ¯ ç³»ç»Ÿä¼˜åŠ¿

1. **æ— éœ€æ³¨å†Œç™»å½•** âœ…
   - ç”¨æˆ·é¦–æ¬¡æ‰“å¼€APPå³å¯ä½¿ç”¨
   - device_id ä½œä¸ºå”¯ä¸€æ ‡è¯†

2. **æ•°æ®éš”ç¦»** âœ…
   - æ¯ä¸ªç”¨æˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
   - é€šè¿‡ user_id è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤

3. **å®‰å…¨æ€§** âœ…
   - JWT Token æœºåˆ¶
   - Token åŒ…å«è¿‡æœŸæ—¶é—´
   - æ”¯æŒ Token åˆ·æ–°

4. **å¤šè®¾å¤‡æ”¯æŒ** âœ…
   - åŒä¸€device_idå¯ä»¥åœ¨ä¸åŒæ—¶é—´ç™»å½•
   - æ”¯æŒè®°å½•å¤šä¸ªè®¾å¤‡ï¼ˆuser_devicesè¡¨ï¼‰

## ğŸ“ æ•°æ®è¡¨å…³ç³»

```
users (ç”¨æˆ·è¡¨)
â”œâ”€ id (UUID, PRIMARY KEY)  â† æ ¸å¿ƒç”¨æˆ·æ ‡è¯†
â”œâ”€ device_id (UNIQUE)      â† è®¾å¤‡å”¯ä¸€æ ‡è¯†
â”œâ”€ name
â”œâ”€ diabetes_type
â”œâ”€ height
â””â”€ weight

meal_records (ç”¨é¤è®°å½•)
â”œâ”€ id
â”œâ”€ user_id (FK â†’ users.id)  âœ… å…³è”ç”¨æˆ·
â”œâ”€ meal_time
â””â”€ ...

nutrition_records (è¥å…»è®°å½•)
â”œâ”€ id
â”œâ”€ user_id (FK â†’ users.id)  âœ… å…³è”ç”¨æˆ·
â”œâ”€ total_calories
â””â”€ ...

exercise_records (è¿åŠ¨è®°å½•)
â”œâ”€ id
â”œâ”€ user_id (FK â†’ users.id)  âœ… å…³è”ç”¨æˆ·
â”œâ”€ exercise_time
â””â”€ ...

water_records (é¥®æ°´è®°å½•)
â”œâ”€ id
â”œâ”€ user_id (FK â†’ users.id)  âœ… å…³è”ç”¨æˆ·
â”œâ”€ record_time
â””â”€ ...

medication_records (ç”¨è¯è®°å½•)
â”œâ”€ id
â”œâ”€ user_id (FK â†’ users.id)  âœ… å…³è”ç”¨æˆ·
â”œâ”€ medication_time
â””â”€ ...

bg_predictions (è¡€ç³–é¢„æµ‹)
â”œâ”€ id
â”œâ”€ user_id (FK â†’ users.id)  âœ… å…³è”ç”¨æˆ·
â”œâ”€ predicted_bg
â””â”€ ...
```

## ğŸ” å®‰å…¨æœºåˆ¶

1. **JWT Token éªŒè¯**
   ```python
   @router.get("/protected-endpoint")
   async def protected(current_user: UserResponse = Depends(get_current_user_dependency)):
       # current_user ç”± JWT token è§£æå¾—åˆ°
       # current_user.id å°±æ˜¯ user_id
       # æ‰€æœ‰æ•°æ®æŸ¥è¯¢éƒ½ä½¿ç”¨è¿™ä¸ª user_id
       pass
   ```

2. **æ•°æ®è®¿é—®æ§åˆ¶**
   - æ¯ä¸ªAPIéƒ½å¿…é¡»æä¾›æœ‰æ•ˆçš„JWT token
   - Tokenä¸­åŒ…å«user_id
   - æ‰€æœ‰æ•°æ®æŸ¥è¯¢éƒ½åŠ ä¸Š `WHERE user_id = :user_id`
   - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®

3. **Token è¿‡æœŸå’Œåˆ·æ–°**
   - Token é»˜è®¤30åˆ†é’Ÿè¿‡æœŸ
   - APPè‡ªåŠ¨æ£€æµ‹tokenæœ‰æ•ˆæ€§
   - å¤±æ•ˆæ—¶è‡ªåŠ¨ä½¿ç”¨device_idé‡æ–°è®¤è¯

## ğŸš€ æœ€ä½³å®è·µ

### åç«¯APIå¼€å‘è§„èŒƒ

```python
@router.get("/some-endpoint")
async def some_endpoint(
    # 1. æ€»æ˜¯æ·»åŠ è¿™ä¸ªä¾èµ–æ³¨å…¥
    current_user: UserResponse = Depends(get_current_user_dependency)
):
    # 2. ä½¿ç”¨ current_user.id ä½œä¸º user_id
    user_id = current_user.id
    
    # 3. æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢éƒ½è¦è¿‡æ»¤ user_id
    query = """
        SELECT * FROM some_table 
        WHERE user_id = :user_id
    """
    result = await database.fetch_all(
        query=query,
        values={"user_id": user_id}
    )
    
    return result
```

### Androidå®¢æˆ·ç«¯å¼€å‘è§„èŒƒ

```kotlin
// 1. åœ¨ViewModelä¸­è°ƒç”¨APIå‰ç¡®ä¿è®¤è¯
class SomeViewModel(private val apiService: ApiService) {
    fun fetchData(context: Context) {
        viewModelScope.launch {
            try {
                // ç¡®ä¿å·²è®¤è¯
                TokenManager.ensureAuthenticated(context, apiService)
                
                // è°ƒç”¨APIï¼ˆè‡ªåŠ¨å¸¦ä¸Štokenï¼‰
                val response = apiService.someEndpoint()
                
                // å¤„ç†å“åº”
                if (response.isSuccessful) {
                    // ...
                }
            } catch (e: Exception) {
                // å¤„ç†é”™è¯¯
            }
        }
    }
}
```

## ğŸ“Œ æ€»ç»“

### âœ… å·²å®Œç¾å®ç°

1. âœ… APPå¯åŠ¨æ—¶æ ¹æ®device_idç”Ÿæˆ/è·å–userId
2. âœ… userIdä½œä¸ºç”¨æˆ·æ•°æ®ç®¡ç†çš„æ ¸å¿ƒ
3. âœ… æ‰€æœ‰ç”¨æˆ·æ•°æ®éƒ½æ ¹æ®userIdæ¥è·å–
4. âœ… JWT Tokenæœºåˆ¶ç¡®ä¿å®‰å…¨æ€§
5. âœ… æ•°æ®å®Œå…¨éš”ç¦»
6. âœ… æ”¯æŒæ— ç¼çš„è®¾å¤‡è®¤è¯

### ğŸ’¡ ç³»ç»Ÿç‰¹ç‚¹

- **é›¶æ‘©æ“¦æ³¨å†Œ**: ç”¨æˆ·æ— éœ€è¾“å…¥ä»»ä½•ä¿¡æ¯å³å¯ä½¿ç”¨
- **æ•°æ®å®‰å…¨**: åŸºäºJWTå’Œuser_idçš„åŒé‡ä¿æŠ¤
- **å¯æ‰©å±•æ€§**: åç»­å¯ä»¥æ·»åŠ é‚®ç®±/å¯†ç ç™»å½•
- **å¤šè®¾å¤‡æ”¯æŒ**: å¯ä»¥å…³è”å¤šä¸ªè®¾å¤‡åˆ°åŒä¸€è´¦æˆ·

### ğŸ‰ ç»“è®º

**å½“å‰ç³»ç»Ÿå·²ç»å®Œç¾å®ç°äº†åŸºäºdevice_idçš„ç”¨æˆ·ç®¡ç†æœºåˆ¶ã€‚**
æ‰€æœ‰APIéƒ½æ­£ç¡®åœ°ä½¿ç”¨user_idè¿›è¡Œæ•°æ®æŸ¥è¯¢å’Œè¿‡æ»¤ï¼Œ
ç¡®ä¿ç”¨æˆ·æ•°æ®çš„å®‰å…¨æ€§å’Œéš”ç¦»æ€§ã€‚

